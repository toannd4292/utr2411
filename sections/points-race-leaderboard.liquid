<script>
  function searchTable(inputId, tableId) {
    var input, filter, table, tr, td, i, txtValue, nameColumnIndex;

    input = document.getElementById(inputId);
    filter = input.value.toUpperCase();

    table = document.getElementById(tableId);
    tr = table.getElementsByTagName("tr");

    var headers = table.getElementsByTagName("thead")[0].getElementsByTagName("th");
    nameColumnIndex = -1;

      for (i = 0; i < headers.length; i++) {
          if (headers[i].getAttribute("data-sort")?.toLowerCase() === "name") {
              nameColumnIndex = i;
              break;
          }
      }

    if (nameColumnIndex === -1) {
        alert("Column 'Name' not found in table.");
        return;
    }

    for (i = 1; i < tr.length; i++) {
        td = tr[i].getElementsByTagName("td")[nameColumnIndex];

        if (td) {
            txtValue = td.textContent || td.innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
                tr[i].style.display = "";
            } else {
                tr[i].style.display = "none";
            }
        }
    }
}

  function myFunction() {
      searchTable("searchInput", "rankingTable_1");
  }
  
  function myFunctionRanking2() {
      searchTable("searchInputRanking", "rankingTable_2");
  }
</script>

<div class="page-width text-center pb-lg-4 pb-sm-0 mb-lg-2">
  <div class="mb-4" style="margin-bottom: 2rem">
      <h2 class="text-uppercase section-title section-title-sm mb-0">{{section.settings.heading}}</h2>
      {%- if section.settings.heading-permission == "YES" -%}
      <div class="divider-sm-teal divider-lg-teal"></div>
    {%- endif -%}
    {% if section.settings.updated != blank %}
      <div class="date-update text-{{ section.settings.text_align }}" style="font-style: italic; font-size: 14px; margin: 40px 0;">
        {{ section.settings.updated }}
      </div>
    {% endif %}
  </div>  
  <div class="custom-button">
    <form class="mr-auto bg_black flex-search-bg">
      <div class="d-flex gap-2 align-items-center justify-content-center">
          <div class="flex-column d-flex w-xl-100">
            <label>Search Name</label>
            <div class="position-relative">        
                <svg class="mapicon" width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M10 17.2C7.5 17.2 5.29 15.92 4 14C4.03 12 8 10.9 10 10.9C12 10.9 15.97 12 16 14C15.3389 14.9844 14.4459 15.7912 13.3996 16.3492C12.3533 16.9072 11.1858 17.1994 10 17.2ZM10 3C10.7956 3 11.5587 3.31607 12.1213 3.87868C12.6839 4.44129 13 5.20435 13 6C13 6.79565 12.6839 7.55871 12.1213 8.12132C11.5587 8.68393 10.7956 9 10 9C9.20435 9 8.44129 8.68393 7.87868 8.12132C7.31607 7.55871 7 6.79565 7 6C7 5.20435 7.31607 4.44129 7.87868 3.87868C8.44129 3.31607 9.20435 3 10 3ZM10 0C8.68678 0 7.38642 0.258658 6.17317 0.761205C4.95991 1.26375 3.85752 2.00035 2.92893 2.92893C1.05357 4.8043 0 7.34784 0 10C0 12.6522 1.05357 15.1957 2.92893 17.0711C3.85752 17.9997 4.95991 18.7362 6.17317 19.2388C7.38642 19.7413 8.68678 20 10 20C12.6522 20 15.1957 18.9464 17.0711 17.0711C18.9464 15.1957 20 12.6522 20 10C20 4.47 15.5 0 10 0Z" fill="#00C0F7"></path>
                </svg>
              <input id="searchInput" onkeyup="myFunction()" type="text" class="gotham-bold text-black px-4 text-uppercase" placeholder="Enter Search Text" autocomplete="off"/>
              <input id="searchInputRanking" onkeyup="myFunctionRanking2()" type="text" class="gotham-bold text-black px-4 text-uppercase" placeholder="Enter Search Text" autocomplete="off"/>
            </div>      
          </div>
         <div class="flex-column d-flex">
            <button class="blue-teal-gradient-bg search-icon">
              <summary class="header__icon header__icon--search header__icon--summary link focus-inset modal__toggle" aria-haspopup="dialog" aria-label="{{ 'general.search.search' | t }}">
              <span class="text-white">
                <svg class="modal__toggle-open icon icon-search" aria-hidden="true" focusable="false" role="presentation">
                  <use href="#icon-search"></use>
                </svg>
              </span>
            </summary>
            </button>
          </div>
        </div>   
    </form>
    <div class="button-container">
      <div class="button-content">
        <p id="btn-left" class="leaderboard_1 btn active">{{ section.settings.button_first }}</p>
        <p id="btn-right" class="leaderboard_2 btn">{{ section.settings.button_second }}</p>
          {% if section.settings.show_table == true %}
              <input type="hidden" id="show_table" value="leaderboard_2">
          {% endif %}
        <input type="hidden" id="limit_row" value="{{ section.settings.limit_row }}">
      </div>
    </div>
  </div>
  
</div>
<div class="page-width pb-lg-5 pt-lg-5 pt-sm-1 pb-sm-2 leaderboard-1">
  <div class="grid grid--1-col grid--1-col-tablet grid--3-col-desktop pt-lg-5">
        {% for block in section.blocks %}
        <input type="hidden" id="input_leaderboard1" value="{{ section.settings.csv_leaderboard1 }}">
        {%- if block.settings.ranking_permison == "2" -%}  
        <div class="grid__item order-sm-last order-md-last pt-md-5 pb-md-5" id="2nd">
          <div class="blue-teal-gradient-bg border-radius-lg-3 border-radius-sm-3 shadow-xl p-2 position-relative racepoint-top-sm custom-racepoint-top-sm">
            <div class="racepoint racepoint3  d-flex align-items-center justify-content-center">
              <div>2</div>
              <div><span>nd</span></div>
            </div>
            <div class="d-flex justify-content-between align-items-center pb-lg-1 mb-sm-1">
              <div>
                <p class="font-lg-20font-sm-12 mb-0 mt-0 fw-bold text-black custom-font">Points</p>
                <p class="font-lg-28 font-sm-28 mb-0 mt-0 text-black text-center">{{block.settings.score}}</p>
              </div>
              <div>
                <p class="font-lg-20 font-sm-12 mb-0 mt-0 fw-bold text-black custom-font">UTR Rating</p>
                <p class="font-lg-28 font-sm-28 mb-0 mt-0 text-black text-center">{{block.settings.utr_rating}}</p>
              </div>
            </div>
            <div class="text-center">
              <h3 class="mt-1 mb-0 font-lg-20 font-md-16 fw-bold">{{block.settings.player_name}}</h3>
              <p class="mt-0 mb-0 font-lg-14 font-sm-12 fw-bold">{{block.settings.player_location}}</p>
            </div>
          </div>
        </div>
        {% elsif block.settings.ranking_permison == "1" %}
        <div class="grid__item order-sm-first order-md-first mt-nt-5" id="1st">
        <div class="blue-teal-gradient-bg border-radius-lg-3 border-radius-sm-3 shadow-xl p-2 position-relative racepoint-top-sm custom-racepoint-top-sm">
        <div class="racepoint racepoint3 d-flex align-items-center justify-content-center">
        <div>1</div><div><span>st</span></div></div>
        <div class="d-flex justify-content-between align-items-center pb-lg-1 mb-sm-1">
        <div>
          <p class="font-lg-20 font-sm-12 mb-0 mt-0 fw-bold text-black custom-font">Points</p>
          <p class="font-lg-28 font-sm-28 mb-0 mt-0 text-black text-center">{{block.settings.score}}</p>
        </div>
        <div>
          <p class="font-lg-20 font-sm-12 mb-0 mt-0 fw-bold text-black custom-font">UTR Rating</p>
          <p class="font-lg-28 font-sm-28 mb-0 mt-0 text-black text-center">{{block.settings.utr_rating}}</p>
        </div></div>
        <div class="text-center">
          <h3 class="mt-1 mb-0 font-lg-20 font-md-16 fw-bold">{{block.settings.player_name}}</h3>
          <p class="mt-0 mb-0 font-lg-14 font-sm-12 fw-bold">{{block.settings.player_location}}</p>
        </div>
        </div>
        </div>
        {% else block.settings.ranking_permison == "3" %}
        <div class="grid__item order-sm-last order-md-last" id="3rd">
        <div class="blue-teal-gradient-bg border-radius-lg-3 border-radius-sm-3 shadow-xl p-2 position-relative racepoint-top-sm custom-racepoint-top-sm">
        <div class="racepoint racepoint3 d-flex align-items-center justify-content-center">
        <div>3</div><div><span>rd</span></div></div>
        <div class="d-flex justify-content-between align-items-center pb-lg-1 mb-sm-1">
        <div>
          <p class="font-lg-20 font-sm-12 mb-0 mt-0 fw-bold text-black custom-font">Points</p>
          <p class="font-lg-28 font-sm-28 mb-0 mt-0 text-black text-center">{{block.settings.score}}</p>
        </div>
        <div>
          <p class="font-lg-20 font-sm-12 mb-0 mt-0 fw-bold text-black custom-font">UTR Rating</p>
          <p class="font-lg-28 font-sm-28 mb-0 mt-0 text-black text-center">{{block.settings.utr_rating}}</p>
        </div></div>
        <div class="text-center">
          <h3 class="mt-1 mb-0 font-lg-20 font-md-16 fw-bold">{{block.settings.player_name}}</h3>
          <p class="mt-0 mb-0 font-lg-14 font-sm-12 fw-bold">{{block.settings.player_location}}</p>
        </div>
        </div>
        </div>
      {% endif %} 
      {% endfor %} 
      </div>
   <div class="d-lg-none d-sm-block">
     <div class="pt-lg-3 pb-lg-2 pt-sm-1 pb-sm-2 pt-sm-1 d-flex justify-content-center align-items-center">
       <a href="#" class="text-uppercase pointer-events-none lightbluebtn button-theme-teal d-flex gap-1 gotham-medium font-sm-14"><img src="https://cdn.shopify.com/s/files/1/0690/8071/1488/files/rotate-mobile.svg?v=1672208434" />rotate your device</a>
     </div>  
  </div>
</div>  

<div class="page-width pb-lg-5 pt-lg-5 pt-sm-1 pb-sm-2 leaderboard-2" style="display:none;">
  <div class="grid grid--1-col grid--1-col-tablet grid--3-col-desktop pt-lg-5">
        {% for block in section.blocks %}
        <input type="hidden" id="input_leaderboard2" value="{{ section.settings.csv_leaderboard2 }}">
        {%- if block.settings.ranking_permison_2 == "2" -%}  
        <div class="grid__item order-sm-last order-md-last pt-md-5 pb-md-5" id="2nd">
          <div class="blue-teal-gradient-bg border-radius-lg-3 border-radius-sm-3 shadow-xl p-2 position-relative racepoint-top-sm custom-racepoint-top-sm">
            <div class="racepoint racepoint3  d-flex align-items-center justify-content-center">
              <div>2</div>
              <div><span>nd</span></div>
            </div>
            <div class="d-flex justify-content-between align-items-center pb-lg-1 mb-sm-1">
              <div>
                <p class="font-lg-20 font-sm-12 mb-0 mt-0 fw-bold text-black custom-font">Points</p>
                <p class="font-lg-28 font-sm-28 mb-0 mt-0 text-black text-center">{{block.settings.score_2}}</p>
              </div>
              <div>
                <p class="font-lg-20 font-sm-12 mb-0 mt-0 fw-bold text-black custom-font">UTR Rating</p>
                <p class="font-lg-28 font-sm-28 mb-0 mt-0 text-black text-center">{{block.settings.utr_rating_2}}</p>
              </div>
            </div>
            <div class="text-center">
              <h3 class="mt-1 mb-0 font-lg-20 font-md-16 fw-bold">{{block.settings.player_name_2}}</h3>
              <p class="mt-0 mb-0 font-lg-14 font-sm-12 fw-bold">{{block.settings.player_location_2}}</p>
            </div>
          </div>
        </div>
        {% elsif block.settings.ranking_permison_2 == "1" %}
        <div class="grid__item order-sm-first order-md-first mt-nt-5" id="1st">
        <div class="blue-teal-gradient-bg border-radius-lg-3 border-radius-sm-3 shadow-xl p-2 position-relative racepoint-top-sm custom-racepoint-top-sm">
        <div class="racepoint racepoint3 d-flex align-items-center justify-content-center">
        <div>1</div><div><span>st</span></div></div>
        <div class="d-flex justify-content-between align-items-center pb-lg-1 mb-sm-1">
        <div>
          <p class="font-lg-20 font-sm-12 mb-0 mt-0 fw-bold text-black custom-font">Points</p>
          <p class="font-lg-28 font-sm-28 mb-0 mt-0 text-black text-center">{{block.settings.score_2}}</p>
        </div>
        <div>
          <p class="font-lg-20 font-sm-12 mb-0 mt-0 fw-bold custom-font text-black">UTR Rating</p>
          <p class="font-lg-28 font-sm-28 mb-0 mt-0 text-black text-center">{{block.settings.utr_rating_2}}</p>
        </div></div>
        <div class="text-center">
          <h3 class="mt-1 mb-0 font-lg-20 font-md-16 fw-bold">{{block.settings.player_name_2}}</h3>
          <p class="mt-0 mb-0 font-lg-14 font-sm-12 fw-bold">{{block.settings.player_location_2}}</p>
        </div>
        </div>
        </div>
        {% else block.settings.ranking_permison_2 == "3" %}
        <div class="grid__item order-sm-last order-md-last" id="3rd">
        <div class="blue-teal-gradient-bg border-radius-lg-3 border-radius-sm-3 shadow-xl p-2 position-relative racepoint-top-sm custom-racepoint-top-sm">
        <div class="racepoint racepoint3 d-flex align-items-center justify-content-center">
        <div>3</div><div><span>rd</span></div></div>
        <div class="d-flex justify-content-between align-items-center pb-lg-1 mb-sm-1">
        <div>
          <p class="font-lg-20 custom-font font-sm-12 mb-0 mt-0 fw-bold text-black">Points</p>
          <p class="font-lg-28 font-sm-28 mb-0 mt-0 text-black text-center">{{block.settings.score_2}}</p>
        </div>
        <div>
          <p class="font-lg-20 custom-font font-sm-12 mb-0 mt-0 fw-bold text-black">UTR Rating</p>
          <p class="font-lg-28 font-sm-28 mb-0 mt-0 text-black text-center">{{block.settings.utr_rating_2}}</p>
        </div></div>
        <div class="text-center">
          <h3 class="mt-1 mb-0 font-lg-20 font-md-16 fw-bold">{{block.settings.player_name_2}}</h3>
          <p class="mt-0 mb-0 font-lg-14 font-sm-12 fw-bold">{{block.settings.player_location_2}}</p>
        </div>
        </div>
        </div>
      {% endif %} 
      {% endfor %} 
      </div>
   <div class="d-lg-none d-sm-block">
     <div class="pt-lg-3 pb-lg-2 pt-sm-1 pb-sm-2 pt-sm-1 d-flex justify-content-center align-items-center">
       <a href="#" class="text-uppercase pointer-events-none lightbluebtn button-theme-teal d-flex gap-1 gotham-medium font-sm-14"><img src="https://cdn.shopify.com/s/files/1/0690/8071/1488/files/rotate-mobile.svg?v=1672208434" />rotate your device</a>
     </div>  
  </div>
</div> 

<div class="pb-lg-2 pt-lg-2 pt-sm-2 pb-sm-2 bg bg_white shadow-xxl">
  <div class="page-width">
    <div class="table-responsive table-scroll-black">
      <table class="table2" id="rankingTable_1">
        <thead class="thead-b-bottom">
          <tr>
            
          </tr>
        </thead>
        <tbody id="tableLeaderboard1" class="tableLeaderboard">
          
        </tbody>
      </table>

      <table class="table2 " id="rankingTable_2">
        <thead class="thead-b-bottom">
          <tr>
            
          </tr>
        </thead>
        <tbody id="tableLeaderboard2" class="tableLeaderboard">
          
        </tbody>
      </table>
    </div>
  </div>
</div>
<style>
  .button-container {
    display: flex;
    margin-top: 20px;
    .button-content {
      display: flex;
      margin: auto;
      border: 1px solid;
    }
    .btn {
      padding: 15px 20px;
      font-weight: 800;
      margin: unset;
      cursor: pointer;
    }
    .active {
      background-color: #000000;
      color: #ffffff;
    }
  }
  .points-race-leaderbroard {
      th .sort-arrow {
          font-size: 8px;
          margin-left: 5px;
          visibility: visible;
      }

      th .sort-arrow-up {
          color: #ddd;
      }

      th .sort-arrow-down {
          color: #ddd;
      }

      th.sort-asc .sort-arrow-up {
          color: #008000;
          font-weight: bold;
      }

      th.sort-desc .sort-arrow-down {
          color: #9C3200;
          font-weight: bold;
      }

      th.sort-asc .sort-arrow-down {
          color: #ddd;
      }

      th.sort-desc .sort-arrow-up {
          color: #ddd;
      }
      .table2 tr th {
          position: relative;
          .sort-arrow {
              display: none;
          }
          .sort-arrow-up {
              position: absolute;
              top: 18px;
          }
      }
      .link-url {
      text-decoration: none;
      color: #000000;
    }
    .link-url:hover {
      text-decoration: underline;
    }
    .flag-cell {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .custom-column {
      /* width: 335px; */
    }
    .custom-font {
      letter-spacing: 0.6px;
      font-family: 'Assistant';
    }
  }
  @media screen and (max-width: 1138px) {
      .points-race-leaderbroard {
          .table2 tr th {
              .sort-arrow-up {
                  /*position: absolute;*/
                  /*top: 12px;*/
              }
              .sort-arrow-down {
                  position: absolute;
                  bottom: 35%;
              }
          }
      }
  }

  @media screen and (max-width: 1072px) {
      .points-race-leaderbroard {
          .event-play {
              width: 150px;
          }
          .table2 tr th {
              .sort-arrow-up {
                  position: absolute;
                  /*top: 38%;*/
              }
              .sort-arrow-down {
                  position: absolute;
                  /*bottom: 38%;*/
              }
          }
      }
  }

  @media screen and (max-width: 991px) {
      .points-race-leaderbroard {
          .table2 tr th {
              .sort-arrow-up {
                  position: absolute;
                  top: 12px;
              }
              .sort-arrow-down {
                  position: absolute;
                  bottom: 22%;
              }
          }
      }
  }

  @media screen and (max-width: 880px) {
      .points-race-leaderbroard {
          .event-play {
              width: 100px;
          }
          .table2 tr th {
              .sort-arrow-up {
                  position: absolute;
                  /*top: 33%;*/
              }
              .sort-arrow-down {
                  position: absolute;
                  /*bottom: 30%;*/
              }
          }
      }
  }

  @media screen and (max-width: 768px) {
      .points-race-leaderbroard {
          .table2 tr th {
              .sort-arrow-up {
                  position: absolute;
                  top: 22%;
              }
              .sort-arrow-down {
                  position: absolute;
                  /*bottom: 30%;*/
              }
          }
      }
  }

  @media screen and (max-width: 630px) {
      .points-race-leaderbroard {
          /*.event-play {*/
          /*    width: 100px;*/
          /*}*/
          .table2 tr th {
              .sort-arrow-up {
                  position: absolute;
                  top: 30%;
              }
              .sort-arrow-down {
                  position: absolute;
                  bottom: 30%;
              }
          }
      }
  }

  @media screen and (max-width: 450px) {
    .points-race-leaderbroard {
      .btn {
        padding: 10px 15px;
        font-size: 14px;
      }
      .custom-racepoint-top-sm {
        margin-top: 40px;
      }

        .table2 tr th {
            .sort-arrow-up {
                position: absolute;
                top: 20px;
            }
            .sort-arrow-down {
                position: absolute;
                top: 30px;
            }
        }
      
      /* input {
    font-size: 16px;
    transform: scale(1);
    transform-origin: 0 0;
} */

    }
  }
</style>
{% if section.settings.show_table == true %}
    <script>
        $(document).ready(function () {
            var showTable = $('#show_table').val();

            if (showTable === "leaderboard_2") {
                setTimeout(function () {
                    $("#btn-right").trigger("click");
                }, 300);
            }
        });
    </script>
{% endif %}

<script>
//   document.getElementById('searchInput').addEventListener('touchstart', function(event) {
//     event.preventDefault(); // Ngăn hành vi mặc định
//     this.focus(); // Gọi focus thủ công
// });

  $(document).ready(function() {

    $('#rankingTable_2').hide();
    $('#searchInputRanking').hide();
    
  function toggleLeaderboard(buttonId, leaderboardToShow, leaderboardToHide, tableToShow, tableToHide, searchInputToShow, searchInputToHide) {
      $('.btn').removeClass('active');
      $(buttonId).addClass('active');
      
      $(leaderboardToShow).show();  
      $(leaderboardToHide).hide();
      $(tableToShow).show();
      $(tableToHide).hide();
      $(searchInputToShow).show();
      $(searchInputToHide).hide();
  }
  
  $('#btn-left').click(function() {
      toggleLeaderboard('#btn-left', '.leaderboard-1', '.leaderboard-2', '#rankingTable_1', '#rankingTable_2', '#searchInput', '#searchInputRanking');
  });
  
  $('#btn-right').click(function() {
      toggleLeaderboard('#btn-right', '.leaderboard-2', '.leaderboard-1', '#rankingTable_2', '#rankingTable_1', '#searchInputRanking', '#searchInput');
  });

  let leaderboard1 = $('#input_leaderboard1').val();
  let leaderboard2 = $('#input_leaderboard2').val();
    
  async function getFlagAndCountryInfo(countryAlpha3Code) {
    const response = await fetch('https://cdn.shopify.com/s/files/1/0690/8071/1488/files/new_flags_iso_version-3_-_new_flags_iso_1_.csv.csv?v=1743154883');
    const text = await response.text();
    const rows = text.split('\n');
    const headers = rows[0].split(',').map(header => header.trim());

    const countryCodeColumnIndex = headers.indexOf('Alpha-3 code');
    const countryNameColumnIndex = headers.indexOf('Country');
    const flagUrlColumnIndex = headers.indexOf('URL');

    if (countryCodeColumnIndex === -1 || countryNameColumnIndex === -1 || flagUrlColumnIndex === -1) {
        console.error("Country code, country name, or flag URL columns not found.");
        return { flagImageUrl: '', countryName: '' };
    }

    let countryInfo = { flagImageUrl: '', countryName: '' };

    rows.slice(1).forEach(row => {
        const columns = row.split(',');

        if (columns[countryCodeColumnIndex] === countryAlpha3Code) {
            countryInfo.countryName = columns[countryNameColumnIndex];
            countryInfo.flagImageUrl = columns[flagUrlColumnIndex];
        }
    });

    if (!countryInfo.countryName || !countryInfo.flagImageUrl) {
        console.error(`No information found for Alpha-3 code ${countryAlpha3Code}`);
        return { flagImageUrl: '', countryName: '' };
    }

    return countryInfo;
}


    async function generateLeaderboard(data, tableSelector) {
    var allRows = data.split(/\r?\n|\r/);
    var headers = allRows[0].split(',');
    var headerRow = '<tr>';

        for (var header = 0; header < headers.length; header++) {
            if (headers[header].trim().toLowerCase() === 'profile') continue;
            if (headers[header].trim().toLowerCase() === 'name') {
                headerRow += '<th class="text-left custom-column font-lg-24 font-sm-18" data-sort="' + headers[header].trim() + '" style="cursor: pointer;">' + headers[header] + '</th>';
            } else if (headers[header].trim().toLowerCase() === 'country') {
                headerRow += '<th class="text-center font-lg-24 font-sm-18 column-country" data-sort="' + headers[header].trim() + '" style="cursor: pointer;">' + headers[header] + '</th>';
            } else {
                headerRow += '<th class="text-center font-lg-24 font-sm-18" data-sort="' + headers[header].trim() + '" style="cursor: pointer;">' + headers[header] + '</th>';
            }
        }

        headerRow += '</tr>';
    $(tableSelector + ' thead').html(headerRow);

    var countryColumnIndex = headers.findIndex(header => header.trim().toLowerCase() === 'country');
    var urlColumnIndex = headers.findIndex(header => header.trim().toLowerCase() === 'profile');
    var nameColumnIndex = headers.findIndex(header => header.trim().toLowerCase() === 'name');

    var bodyRows = '';
    var maxRows = $('#limit_row').val();

    for (var singleRow = 1; singleRow < allRows.length && singleRow <= maxRows; singleRow++) {
        var rowCells = allRows[singleRow].split(',');
        var rowHtml = '<tr>';

        var countryAlpha3Code = rowCells[countryColumnIndex]?.trim().toUpperCase();
        var flagImageUrl = '';
        var countryName = '';

        if (countryAlpha3Code && countryAlpha3Code.length === 3 && /^[A-Z]+$/.test(countryAlpha3Code)) {
            try {
                const countryInfo = await getFlagAndCountryInfo(countryAlpha3Code);
                flagImageUrl = countryInfo.flagImageUrl;
                countryName = countryInfo.countryName;

                if (flagImageUrl) {
                    rowCells[countryColumnIndex] = `<img src="${flagImageUrl}" alt="${countryAlpha3Code}" title="${countryName}" style="width: 32px; height: 24px; margin-right: 5px;">`;
                } else {
                    rowCells[countryColumnIndex] = `<span class="country-code">${countryAlpha3Code}</span>`;
                }
            } catch (error) {
                console.error('Error fetching flag image:', error);
                rowCells[countryColumnIndex] = `<span class="country-code">${countryAlpha3Code}</span>`;
            }
        } else {
            rowCells[countryColumnIndex] = 'No Country';
        }

        rowCells.forEach((cellData, index) => {

            if (cellData.includes("↑")) {
                cellData = cellData.replace(/↑/g, '<span style="color: #008000;">↑</span>');
            }
            if (cellData.includes("↓")) {
                cellData = cellData.replace(/↓/g, '<span style="color: #9C3200;">↓</span>');
            }

            if (index === countryColumnIndex) {
                rowHtml += `<td class="flag-cell">${cellData}</td>`;
            } else if (index === urlColumnIndex) {
                return;
            } else if (index === nameColumnIndex) {
                if (urlColumnIndex !== -1 && rowCells[urlColumnIndex]) {
                    var profileUrl = rowCells[urlColumnIndex].trim();
                    rowHtml += `<td><a class="link-url" href="${profileUrl}" target="_blank">${cellData}</a></td>`;
                } else {
                    rowHtml += `<td>${cellData}</td>`;
                }
            } else if (index === 7){
                rowHtml += `<td class="text-center event-play">${cellData}</td>`;
            } else {
              if(cellData == 'DNQ'){
                rowHtml += `<td class="text-center DNQ">${cellData}</td>`;
              }else{
                rowHtml += `<td class="text-center">${cellData}</td>`;
              }
            }
        });

        rowHtml += '</tr>';
        bodyRows += rowHtml;
    }

    $(tableSelector + ' tbody').html(bodyRows);
}

      var sortDirections = {};

      function sortTable(tableSelector, n) {
          var table = $(tableSelector);
          var rows = table.find('tbody tr').get();
          var ascending = sortDirections[n] === 'asc' ? false : true;

          rows.sort(function (a, b) {
              var cellA = $(a).children('td').eq(n);
              var cellB = $(b).children('td').eq(n);

              var textA = cellA.text().trim();
              var textB = cellB.text().trim();

              if (cellA.find('img').length > 0 && cellB.find('img').length > 0) {
                  textA = cellA.find('img').attr('alt') || cellA.find('img').attr('title') || "";
                  textB = cellB.find('img').attr('alt') || cellB.find('img').attr('title') || "";
              }

              // console.log("Raw values:", textA, textB); 


              let cleanA = textA.replace(/[^0-9.]/g, '').trim();
              let cleanB = textB.replace(/[^0-9.]/g, '').trim();

              // console.log("Cleaned values:", cleanA, cleanB);

              let isNumeric = /^-?\d+(\.\d+)?$/.test(cleanA) && /^-?\d+(\.\d+)?$/.test(cleanB);

              if (isNumeric) {
                  let numA = parseFloat(cleanA);
                  let numB = parseFloat(cleanB);
                  // console.log("Parsed numbers:", numA, numB);

                  return (numA - numB) * (ascending ? 1 : -1);
              }

              return textA.localeCompare(textB) * (ascending ? 1 : -1);
          });

          $.each(rows, function (index, row) {
              table.children('tbody').append(row);
          });

          sortDirections[n] = ascending ? 'asc' : 'desc';
          updateSortArrows(tableSelector, n, ascending);
      }


      function updateSortArrows(tableSelector, columnIndex, ascending) {
          $(tableSelector + ' th').removeClass('sort-asc sort-desc');
          $(tableSelector + ' th').each(function () {
              $(this).find('.sort-arrow-up').css('font-weight', 'normal').css('color', '#ddd');
              $(this).find('.sort-arrow-down').css('font-weight', 'normal').css('color', '#ddd');
          });


          var sortUpArrow = '<span class="sort-arrow sort-arrow-up">▲</span>';
          var sortDownArrow = '<span class="sort-arrow sort-arrow-down">▼</span>';

          var targetHeader = $(tableSelector + ' th').eq(columnIndex);

          if (ascending) {
              targetHeader.addClass('sort-asc');
          } else {
              targetHeader.addClass('sort-desc');
          }

          if (targetHeader.find('.sort-arrow').length === 0) {
              targetHeader.append(sortUpArrow).append(sortDownArrow);
          }

          if (ascending) {
              targetHeader.find('.sort-arrow-up').css('font-weight', 'bold').css('color', '#008000');
              targetHeader.find('.sort-arrow-down').css('font-weight', 'normal').css('color', '#ddd');
          } else {
              targetHeader.find('.sort-arrow-down').css('font-weight', 'bold').css('color', '#9C3200');
              targetHeader.find('.sort-arrow-up').css('font-weight', 'normal').css('color', '#ddd');
          }
      }

      $.when(
          $.ajax({
              url: leaderboard1,
              dataType: 'text',
          }),
          $.ajax({
              url: leaderboard2,
              dataType: 'text',
          })
      ).done(function (data1, data2) {
          generateLeaderboard(data1[0], '#rankingTable_1');
          generateLeaderboard(data2[0], '#rankingTable_2');

          $('th').each(function () {
              $(this).append('<span class="sort-arrow sort-arrow-up">▲</span><span class="sort-arrow sort-arrow-down">▼</span>');
          });

          $('th', '#rankingTable_1').click(function () {
              var columnIndex = $(this).index();
              var sortType = $(this).data('sort');

              var isNumeric = ['Rank', 'Age', 'Points', 'UTR', 'Events Played', 'GRIT Ranking', 'Name', 'City','UTR Rating', 'GRIT Score'].includes(sortType);

              sortTable('#rankingTable_1', columnIndex, isNumeric);
          });

          $('th', '#rankingTable_2').click(function () {
              var columnIndex = $(this).index();
              var sortType = $(this).data('sort');

              var isNumeric = ['Rank', 'Age', 'Points', 'UTR', 'Events Played', 'GRIT Ranking', 'Name', 'City','UTR Rating', 'GRIT Score'].includes(sortType);

              sortTable('#rankingTable_2', columnIndex, isNumeric);
          });
      });

  });

</script>
{% schema %}
  {
    "name": "Points Race Leaderboard",
    "class": "points-race-leaderbroard",
    "presets": [
      {
        "name": "Points Race Leaderboard",
        "category": "Points Race Leaderboard"
      }
    ],
    "settings": [
       {
			"type":"text",
			"id":"heading",
			"label": "Heading Title"
	    },
        {
          "type": "radio",
          "id": "heading-permission",
          "label": "Do You Want Underline Below Heading?",
          "default": "NO",
          "options": [
        {
          "value": "NO",
          "label": "NO"
        },
        {
          "value": "YES",
          "label": "YES"
        }
          ]
        },
        {
          "type": "richtext",
          "id": "updated",
          "label": "File update date"
        },
        {
          "type": "select",
          "id": "text_align",
          "options": [
            {
              "value": "left",
              "label": "Left"
            },
            {
              "value": "center",
              "label": "Center"
            },
            {
              "value": "right",
              "label": "Right"
            }
          ],
          "default": "center",
          "label": "Text align"
        },
        {
          "type": "text",
          "id": "button_first",
          "label": "Title Button First"
        },
        {
            "type": "text",
            "id": "csv_leaderboard1",
            "label": "CSV Leaderboard 1"
        },
        {
          "type": "text",
          "id": "button_second",
          "label": "Title Button Second"
        },
        {
          "type": "text",
          "id": "csv_leaderboard2",
          "label": "CSV Leaderboard 2"
        },
      {
          "type": "number",
          "id": "limit_row",
          "label": "Number Row",
          "default": 100
        },
      {
        "type": "checkbox",
        "id": "show_table",
        "label": "Show Table 2",
        "default": false
      }
        
    ],
    "max_blocks": 3,
  "blocks":[
	  {
		"type":"home-card",
		"name":"Leaderboard Block",
		"settings":[
          {
           "type": "header",
            "content": "Leaderboard Block 1/2"
          },
          {
            "type": "radio",
            "id": "ranking_permison",
            "label": "Select Ranking",
            "default": "2",
            "options": [
                {
                    "value": "1",
                    "label": "1"
                },
                {
                    "value": "2",
                    "label": "2"
                },
                {
                    "value": "3",
                    "label": "3"
                }
            ]
        },
        {
		"type": "text",
		"id": "score",
		"label": "Score"
    	},
        {
    		"type": "text",
    		"id": "utr_rating",
    		"label": "UTR Rating"
    	},
        {
    		"type": "text",
    		"id": "player_name",
    		"label": "Player Name"
    	},
        {
    		"type": "text",
    		"id": "player_location",
    		"label": "Player Location"
    	},
        {
          "type": "header",
          "content": "Leaderboard Block 2/2"
        },
        {
          "type": "radio",
          "id": "ranking_permison_2",
          "label": "Select Ranking",
          "default": "2",
          "options": [
              {
                  "value": "1",
                  "label": "1"
              },
              {
                  "value": "2",
                  "label": "2"
              },
              {
                  "value": "3",
                  "label": "3"
              }
          ]
        },
          {
            "type": "text",
            "id": "score_2",
            "label": "Score"
          },
          {
            "type": "text",
            "id": "utr_rating_2",
            "label": "UTR Rating"
          },
          {
            "type": "text",
            "id": "player_name_2",
            "label": "Player Name"
          },
          {
            "type": "text",
            "id": "player_location_2",
            "label": "Player Location"
          }
		]
	  }
    ]
  }
{% endschema %}

{% stylesheet %}
{% endstylesheet %}

{% javascript %}
  
{% endjavascript %}
{% comment %}
<style>
  .button-container {
    display: flex;
    margin-top: 20px;
    .button-content {
      display: flex;
      margin: auto;
      border: 1px solid;
    }
    .btn {
      padding: 15px 20px;
      font-weight: 800;
      margin: unset;
      cursor: pointer;
    }
    .active {
      background-color: #000000;
      color: #ffffff;
    }
  }
  .points-race-leaderbroard {
    .link-url {
      text-decoration: none;
      color: #000000;
    }
    .link-url:hover {
      text-decoration: underline;
    }
    .flag-cell {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .custom-column {
      /* width: 335px; */
    }
    .custom-font {
      letter-spacing: 0.6px;
      font-family: 'Assistant';
    }
  }
  @media screen and (max-width: 450px) {
    .points-race-leaderbroard {
      .btn {
        padding: 10px 15px;
        font-size: 14px;
      }
      .custom-racepoint-top-sm {
        margin-top: 40px;
      }
      
      /* input {
    font-size: 16px;
    transform: scale(1);
    transform-origin: 0 0;
} */

    }
  }
</style>
<script>
//   document.getElementById('searchInput').addEventListener('touchstart', function(event) {
//     event.preventDefault(); // Ngăn hành vi mặc định
//     this.focus(); // Gọi focus thủ công
// });

  $(document).ready(function() {
    $('#rankingTable_2').hide();
    $('#searchInputRanking').hide();
    
  function toggleLeaderboard(buttonId, leaderboardToShow, leaderboardToHide, tableToShow, tableToHide, searchInputToShow, searchInputToHide) {
      $('.btn').removeClass('active');
      $(buttonId).addClass('active');
      
      $(leaderboardToShow).show();  
      $(leaderboardToHide).hide();
      $(tableToShow).show();
      $(tableToHide).hide();
      $(searchInputToShow).show();
      $(searchInputToHide).hide();
  }
  
  $('#btn-left').click(function() {
      toggleLeaderboard('#btn-left', '.leaderboard-1', '.leaderboard-2', '#rankingTable_1', '#rankingTable_2', '#searchInput', '#searchInputRanking');
  });
  
  $('#btn-right').click(function() {
      toggleLeaderboard('#btn-right', '.leaderboard-2', '.leaderboard-1', '#rankingTable_2', '#rankingTable_1', '#searchInputRanking', '#searchInput');
  });

  let leaderboard1 = $('#input_leaderboard1').val();
  let leaderboard2 = $('#input_leaderboard2').val();
    
  async function getFlagAndCountryInfo(countryAlpha3Code) {
    const response = await fetch('https://cdn.shopify.com/s/files/1/0690/8071/1488/files/new_flags_iso.csv?v=1733814604');
    const text = await response.text();
    const rows = text.split('\n');
    const headers = rows[0].split(',').map(header => header.trim());

    const countryCodeColumnIndex = headers.indexOf('Alpha-3 code');
    const countryNameColumnIndex = headers.indexOf('Country');
    const flagUrlColumnIndex = headers.indexOf('URL');

    if (countryCodeColumnIndex === -1 || countryNameColumnIndex === -1 || flagUrlColumnIndex === -1) {
        console.error("Country code, country name, or flag URL columns not found.");
        return { flagImageUrl: '', countryName: '' };
    }

    let countryInfo = { flagImageUrl: '', countryName: '' };

    rows.slice(1).forEach(row => {
        const columns = row.split(',');

        if (columns[countryCodeColumnIndex] === countryAlpha3Code) {
            countryInfo.countryName = columns[countryNameColumnIndex];
            countryInfo.flagImageUrl = columns[flagUrlColumnIndex];
        }
    });

    if (!countryInfo.countryName || !countryInfo.flagImageUrl) {
        console.error(`No information found for Alpha-3 code ${countryAlpha3Code}`);
        return { flagImageUrl: '', countryName: '' };
    }

    return countryInfo;
}


    async function generateLeaderboard(data, tableSelector) {
    var allRows = data.split(/\r?\n|\r/);
    var headers = allRows[0].split(',');
    var headerRow = '<tr>';

    for (var header = 0; header < headers.length; header++) {
        if (headers[header].trim().toLowerCase() === 'profile') continue;
        if (headers[header].trim().toLowerCase() === 'name') {
          headerRow += '<th class="text-left custom-column font-lg-24 font-sm-18">' + headers[header] + '</th>';
        } else {
          headerRow += '<th class="text-center font-lg-24 font-sm-18">' + headers[header] + '</th>';
        }
    }
    headerRow += '</tr>';
    $(tableSelector + ' thead').html(headerRow);

    var countryColumnIndex = headers.findIndex(header => header.trim().toLowerCase() === 'country');
    var urlColumnIndex = headers.findIndex(header => header.trim().toLowerCase() === 'profile');
    var nameColumnIndex = headers.findIndex(header => header.trim().toLowerCase() === 'name');

    var bodyRows = '';
    var maxRows = $('#limit_row').val();

    for (var singleRow = 1; singleRow < allRows.length && singleRow <= maxRows; singleRow++) {
        var rowCells = allRows[singleRow].split(',');
        var rowHtml = '<tr>';

        var countryAlpha3Code = rowCells[countryColumnIndex]?.trim().toUpperCase();
        var flagImageUrl = '';
        var countryName = '';

        if (countryAlpha3Code && countryAlpha3Code.length === 3 && /^[A-Z]+$/.test(countryAlpha3Code)) {
            try {
                const countryInfo = await getFlagAndCountryInfo(countryAlpha3Code);
                flagImageUrl = countryInfo.flagImageUrl;
                countryName = countryInfo.countryName;

                if (flagImageUrl) {
                    rowCells[countryColumnIndex] = `<img src="${flagImageUrl}" alt="${countryAlpha3Code}" title="${countryName}" style="width: 32px; height: 24px; margin-right: 5px;">`;
                } else {
                    rowCells[countryColumnIndex] = `<span class="country-code">${countryAlpha3Code}</span>`;
                }
            } catch (error) {
                console.error('Error fetching flag image:', error);
                rowCells[countryColumnIndex] = `<span class="country-code">${countryAlpha3Code}</span>`;
            }
        } else {
            rowCells[countryColumnIndex] = 'No Country';
        }

        rowCells.forEach((cellData, index) => {
            if (cellData.includes("↑")) {
                cellData = cellData.replace(/↑/g, '<span style="color: #008000;">↑</span>');
            }
            if (cellData.includes("↓")) {
                cellData = cellData.replace(/↓/g, '<span style="color: #9C3200;">↓</span>');
            }

            if (index === countryColumnIndex) {
                rowHtml += `<td class="flag-cell">${cellData}</td>`;
            } else if (index === urlColumnIndex) {
                return;
            } else if (index === nameColumnIndex) {
                if (urlColumnIndex !== -1 && rowCells[urlColumnIndex]) {
                    var profileUrl = rowCells[urlColumnIndex].trim();
                    rowHtml += `<td><a class="link-url" href="${profileUrl}" target="_blank">${cellData}</a></td>`;
                } else {
                    rowHtml += `<td>${cellData}</td>`;
                }
            } else {
                rowHtml += `<td class="text-center">${cellData}</td>`;
            }
        });

        rowHtml += '</tr>';
        bodyRows += rowHtml;
    }

    $(tableSelector + ' tbody').html(bodyRows);
}

  $.ajax({
      url: leaderboard1,
      dataType: 'text',
  }).done(function(data) {
      generateLeaderboard(data, '#rankingTable_1');
  });
  
  $.ajax({
      url: leaderboard2,
      dataType: 'text',
  }).done(function(data) {
      generateLeaderboard(data, '#rankingTable_2');
  });
});
</script>
{% schema %}
  {
    "name": "Points Race Leaderboard",
    "class": "points-race-leaderbroard",
    "presets": [
      {
        "name": "Points Race Leaderboard",
        "category": "Points Race Leaderboard"
      }
    ],
    "settings": [
       {
			"type":"text",
			"id":"heading",
			"label": "Heading Title"
	    },
        {
          "type": "radio",
          "id": "heading-permission",
          "label": "Do You Want Underline Below Heading?",
          "default": "NO",
          "options": [
        {
          "value": "NO",
          "label": "NO"
        },
        {
          "value": "YES",
          "label": "YES"
        }
          ]
        },
        {
          "type": "text",
          "id": "updated",
          "label": "File update date"
        },
        {
          "type": "text",
          "id": "button_first",
          "label": "Title Button First"
        },
        {
            "type": "text",
            "id": "csv_leaderboard1",
            "label": "CSV Leaderboard 1"
        },
        {
          "type": "text",
          "id": "button_second",
          "label": "Title Button Second"
        },
        {
          "type": "text",
          "id": "csv_leaderboard2",
          "label": "CSV Leaderboard 2"
        },
      {
          "type": "number",
          "id": "limit_row",
          "label": "Number Row",
          "default": 100
        }
        
    ],
    "max_blocks": 3,
  "blocks":[
	  {
		"type":"home-card",
		"name":"Leaderboard Block",
		"settings":[
          {
           "type": "header",
            "content": "Leaderboard Block 1/2"
          },
          {
            "type": "radio",
            "id": "ranking_permison",
            "label": "Select Ranking",
            "default": "2",
            "options": [
                {
                    "value": "1",
                    "label": "1"
                },
                {
                    "value": "2",
                    "label": "2"
                },
                {
                    "value": "3",
                    "label": "3"
                }
            ]
        },
        {
		"type": "text",
		"id": "score",
		"label": "Score"
    	},
        {
    		"type": "text",
    		"id": "utr_rating",
    		"label": "UTR Rating"
    	},
        {
    		"type": "text",
    		"id": "player_name",
    		"label": "Player Name"
    	},
        {
    		"type": "text",
    		"id": "player_location",
    		"label": "Player Location"
    	},
        {
          "type": "header",
          "content": "Leaderboard Block 2/2"
        },
        {
          "type": "radio",
          "id": "ranking_permison_2",
          "label": "Select Ranking",
          "default": "2",
          "options": [
              {
                  "value": "1",
                  "label": "1"
              },
              {
                  "value": "2",
                  "label": "2"
              },
              {
                  "value": "3",
                  "label": "3"
              }
          ]
        },
          {
            "type": "text",
            "id": "score_2",
            "label": "Score"
          },
          {
            "type": "text",
            "id": "utr_rating_2",
            "label": "UTR Rating"
          },
          {
            "type": "text",
            "id": "player_name_2",
            "label": "Player Name"
          },
          {
            "type": "text",
            "id": "player_location_2",
            "label": "Player Location"
          }
		]
	  }
    ]
  }
{% endschema %}

{% stylesheet %}
{% endstylesheet %}

{% javascript %}
  
{% endjavascript %}
{% endcomment %}